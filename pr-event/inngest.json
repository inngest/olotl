{
  "name": "Olotl: PR events",
  "id": "exotic-serval-61e851",
  "triggers": [
    {
      "event": "github/pull_request",
      "definition": {
        "format": "cue",
        "synced": true,
        "def": "file://./events/github-pull_request.cue"
      }
    }
  ],
  "steps": {

    // This step runs immediately after the trigger, and handles common
    // functionality for the pull_request webhook.
    "handle": {
      "id": "handle",
      "path": "file://./steps/handle",
      "name": "New PR"
    },

    // reminder sends a reminder 3 days after the PR is ready to review,
    // if the PR has not yet been merged.
    //
    // It does this by waiting for a "merged" event for the same PR# for
    // 3 days;  if the event is not received this step runs.  The config
    // for this is specified in the 'after' step below, indicating
    // that this step should run only after 'handle' is processed.
    "reminder": {
      "id": "reminder",
      "path": "file://./steps/reminder",
      "name": "reminder",
      "after": [
        {
          // Run after "handle" is procesed.
          "step": "handle",

          // Only run this if new PRs are opened, or if the PR
          // was just switched from Draft -> Ready to review.
          "if": "event.data.action == 'ready_for_review' || (event.data.action == 'opened' && event.data.draft == false)",

          // async indicates that we should wait for another event prior to running
          // this step.  This allows us to build complex user flows, eg:
          // - 'when a user adds a product to the cart...'
          // - 'wait for the checkout event for 72 hours', then...
          //   - as soon as this event is received, run a step
          //   - on timeout (the event is not received), send the user a reminder email.
          "async": {
            // Wait for another `github/pull_request` event (async) which
            // has the same PR number, is in the same repo and is 'closed'.
            "event": "github/pull_request",
            "match": "async.data.number == event.data.number && async.data.pull_request.id == event.data.pull_request.id && async.data.action == 'closed'",

            // Wait for 3 days.
            "ttl": "72h",

            // Only run if this event is not received, eg. when this times out.
            "onTimeout": true
          }
        }
      ]
    }
  }
}
